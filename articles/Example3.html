<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Determining seropositivity from cross-sectional serological data ‚Ä¢ ptmc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Determining seropositivity from cross-sectional serological data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ptmc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Example1.html">Continuous only model</a>
    </li>
    <li>
      <a href="../articles/Example2.html">Negronis all round: simulation recovery of a discrete model üçπ</a>
    </li>
    <li>
      <a href="../articles/Example3.html">Determining seropositivity from cross-sectional serological data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Determining seropositivity from cross-sectional
serological data</h1>
                        <h4 data-toc-skip class="author">David
Hodgson</h4>
            
            <h4 data-toc-skip class="date">2025-02-08</h4>
      

      <div class="hidden name"><code>Example3.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates how to recover a discrete latent variable
model xx We‚Äôll show how to infer the weather state for each day based on
observed Negroni sales using a probabilistic modeling framework.</p>
<div class="section level2">
<h2 id="relevant-packages">1. Relevant packages<a class="anchor" aria-label="anchor" href="#relevant-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#library(ptmc)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Using more than one core might fail on windows, </span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">OS.type</span> <span class="op">==</span> <span class="st">"windows"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mc.cores</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">mc.cores</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># use as many as available, preferably 4.</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulated-serological-data">2. Simulated serological data<a class="anchor" aria-label="anchor" href="#simulated-serological-data"></a>
</h2>
<p>We simulate the dataset as follows:</p>
<p>Each individual has an unobserved (‚Äúlatent‚Äù) seropositivity state
($Z_i ${0 = uninfected, 1 = infected}). For each positivity state we
assume the distribution of titre values is as follows</p>
<ul>
<li>Sunny ‚òÄÔ∏è:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Poisson</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œª</mi><mo>=</mo><mn>20</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y_i \sim \text{Poisson}(\lambda = 20)</annotation></semantics></math>
</li>
<li>Cloudy ‚òÅÔ∏è:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Poisson</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œª</mi><mo>=</mo><mn>10</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y_i \sim \text{Poisson}(\lambda = 10)</annotation></semantics></math>
</li>
<li>Rainy üíß:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Poisson</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œª</mi><mo>=</mo><mn>4</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y_i \sim \text{Poisson}(\lambda = 4)</annotation></semantics></math>
</li>
</ul>
<p>Based on this,let‚Äôs simulate some data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parameters</span></span>
<span><span class="va">n_days</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">weather_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span>, <span class="st">"cloudy"</span>, <span class="st">"rainy"</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">10</span>, <span class="fl">4</span><span class="op">)</span>  <span class="co"># Poisson means for each weather state</span></span>
<span><span class="va">prior_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">0.33</span>, <span class="fl">0.33</span><span class="op">)</span>  <span class="co"># Prior probabilities for each weather state</span></span>
<span></span>
<span><span class="co"># Generate latent weather states</span></span>
<span><span class="va">latent_weather</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">weather_states</span>, size <span class="op">=</span> <span class="va">n_days</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="va">prior_probs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate observed Negroni sales</span></span>
<span><span class="va">sales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">latent_weather</span>, <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">lambda</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">weather_states</span> <span class="op">==</span> <span class="va">w</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine into a data frame</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>day <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_days</span>, sales <span class="op">=</span> <span class="va">sales</span>, weather <span class="op">=</span> <span class="va">latent_weather</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot!</span></span>
<span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">day</span>, y <span class="op">=</span> <span class="va">sales</span>, fill <span class="op">=</span> <span class="va">weather</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"#f6cb2e"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"gray30"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"#1eaefe"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Day"</span>, y <span class="op">=</span> <span class="st">"Negroni sales"</span>, fill <span class="op">=</span> <span class="st">"Weather"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="simulation-recovery">3. Simulation recovery<a class="anchor" aria-label="anchor" href="#simulation-recovery"></a>
</h2>
<div class="section level3">
<h3 id="description-of-the-model">3.1 Description of the model<a class="anchor" aria-label="anchor" href="#description-of-the-model"></a>
</h3>
<p>In our Bayesian model we assume that Observed Negroi Sales
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">Y_i</annotation></semantics></math>)
are Poisson distributed with a rate parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œª</mi><mi>w</mi></msub><annotation encoding="application/x-tex">\lambda_w</annotation></semantics></math>
that depends on the latent weather state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>i</mi></msub><annotation encoding="application/x-tex">W_i</annotation></semantics></math>.
That is the likelihood
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><mi>w</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(Y_i | W_i = w)</annotation></semantics></math>
is Poisson with rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œª</mi><mi>w</mi></msub><annotation encoding="application/x-tex">\lambda_w</annotation></semantics></math>
for each weather state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>w</mi><annotation encoding="application/x-tex">w</annotation></semantics></math>.
We assume the priors on the rate parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œª</mi><mi>w</mi></msub><mspace width="0.222em"></mspace><mtext mathvariant="normal">Unif</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>100</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_w ~ \text{Unif}(0, 100)</annotation></semantics></math>.
Finally, the prior distribution posterior distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>W</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>Y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(W_i | Y_i)</annotation></semantics></math>
is given as the product of the likelihood and prior for each weather
state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>w</mi><annotation encoding="application/x-tex">w</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="steps-to-recover-w_i">3.2 Steps to Recover
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>i</mi></msub><annotation encoding="application/x-tex">W_i</annotation></semantics></math>:<a class="anchor" aria-label="anchor" href="#steps-to-recover-w_i"></a>
</h3>
<p>To recover the latent weather states, we use a Bayesian model with
the following components:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Define the Likelihood Function</strong>: Implement the
Poisson likelihood for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">Y_i</annotation></semantics></math>
given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><mi>w</mi></mrow><annotation encoding="application/x-tex">W_i = w</annotation></semantics></math>
for each weather state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>w</mi><annotation encoding="application/x-tex">w</annotation></semantics></math>.</p></li>
<li><p><strong>Calculate the posterior probabilities</strong>: Use the
likelihood and prior to compute the posterior probabilities for each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>i</mi></msub><annotation encoding="application/x-tex">W_i</annotation></semantics></math>
using Bayes‚Äô Rule.</p></li>
<li><p><strong>Infer the model probable state per day</strong>: Assign
each day to the weather state w with the highest posterior
probability.</p></li>
<li><p><strong>Repeat for all days</strong>: Perform the above inference
for all days in the dataset to recover the sequence of latent weather
states.</p></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">sale</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add all of these entries into a model list</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span><span class="co"># 1. Parameter Bounds (lowerParSupport_fitted and upperParSupport_fitted)</span></span>
<span><span class="co"># These define the lower and upper bounds for the three model parameters: w_r, w_c, and w_s.</span></span>
<span><span class="co"># w_r, w_c, and w_s are restricted to lie between 0 and 100.</span></span>
<span><span class="co"># This ensures that the values for each parameter remain within a reasonable range during model fitting or sampling.</span></span>
<span></span>
<span>  lowerParSupport_fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>  upperParSupport_fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span></span>
<span><span class="co"># 2. Parameter Names (namesOfParameters)</span></span>
<span><span class="co"># namesOfParameters is a vector containing the names of the three parameters that the model will estimate:</span></span>
<span><span class="co">#w_r: the rate associated with the first category (discrete value 1),</span></span>
<span><span class="co">#w_c: the rate associated with the second category (discrete value 2),</span></span>
<span><span class="co">#w_s: the rate associated with the third category (discrete value 3).</span></span>
<span>  namesOfParameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"w_r"</span>, <span class="st">"w_c"</span>, <span class="st">"w_s"</span><span class="op">)</span>,</span>
<span></span>
<span><span class="co">## 3. Discrete Length (discrete_length)</span></span>
<span><span class="co"># This is the length of the discrete sequence (i.e., the number of data points N). The model assumes that discrete has a length of 30, meaning there are 30 discrete latent variables to be inferred from the data, corresponding to 30 days.</span></span>
<span>  discrete_length <span class="op">=</span> <span class="fl">30</span>,</span>
<span></span>
<span><span class="co"># 4. Sampling from Prior Distributions (samplePriorDistributions)</span></span>
<span><span class="co">## The function samplePriorDistributions generates prior samples for the parameters w_r, w_c, and w_s.</span></span>
<span><span class="co">## It samples each parameter independently from a uniform distribution between 0 and 100.</span></span>
<span></span>
<span>  samplePriorDistributions <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span><span class="co"># 5. Evaluating the Log-Prior (evaluateLogPrior)</span></span>
<span><span class="co"># The function evaluateLogPrior calculates the log-prior of the model based on the parameters params (a vector containing w_r, w_c, and w_s).</span></span>
<span>  evaluateLogPrior <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">discrete</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">lpr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">dunif</a></span><span class="op">(</span> <span class="va">params</span>, <span class="fl">0</span>, <span class="fl">100</span>, <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">sum</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">params</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">lpr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">lpr</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span><span class="co"># 6. Initialising the Discrete Latent Variables (initialiseDiscrete)</span></span>
<span><span class="co"># initialiseDiscrete initializes the discrete latent variables for each data point.</span></span>
<span><span class="co"># The function samples N values (where N = 30 in this case) from the set {1, 2, 3}, assigning each data point to one of the three possible categories. This is done randomly with replacement.</span></span>
<span>  initialiseDiscrete <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">N</span></span>
<span></span>
<span>      <span class="va">discrete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">discrete</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span><span class="co">#7. Discrete Sampling (discreteSampling)</span></span>
<span><span class="co"># discreteSampling is a function that updates the latent discrete variable using a random walk approach. It applies a random operation (based on the value of u) to the current state of the discrete vector:</span></span>
<span><span class="co">#With probability 1/3, it randomly resamples one element of the discrete vector and assigns it to a new value from the set {1, 2, 3}.</span></span>
<span><span class="co">#With probability 1/3, it swaps the values of two randomly selected elements in the discrete vector.</span></span>
<span><span class="co">#With the remaining probability, no change is made to the discrete vector.</span></span>
<span>    discreteSampling <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">discrete</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>        <span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">N</span></span>
<span>        <span class="co"># resample</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">u</span> <span class="op">&lt;</span> <span class="fl">0.33</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>          <span class="va">discrete</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>          <span class="co"># swap</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">u</span> <span class="op">&lt;</span> <span class="fl">0.66</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">j_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>          <span class="va">j_idx_1</span> <span class="op">&lt;-</span> <span class="va">discrete</span><span class="op">[</span><span class="va">j_idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> </span>
<span>          <span class="va">discrete</span><span class="op">[</span><span class="va">j_idx</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="va">discrete</span><span class="op">[</span><span class="va">j_idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> </span>
<span>          <span class="va">discrete</span><span class="op">[</span><span class="va">j_idx</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">j_idx_1</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="co"># nothing happens!</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">discrete</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span><span class="co"># 8. Evaluating the Log-Likelihood (evaluateLogLikelihood)</span></span>
<span><span class="co"># The function evaluateLogLikelihood calculates the log-likelihood for a set of parameter values params, given the observed data and the current state of the discrete latent variables.</span></span>
<span><span class="co"># w_r, w_c, and w_s are the three model parameters (rates).</span></span>
<span><span class="co"># The function iterates over each data point (from 1 to N, where N = 30), checking which category (discrete[i]) the data point belongs to.</span></span>
<span><span class="co">#For each category (1, 2, or 3), it calculates the log-likelihood of the observed data point datalist$y[i] under the corresponding Poisson distribution with the rate parameter (w_r, w_c, or w_s).</span></span>
<span><span class="co">#The log-likelihood is accumulated and returned as the total log-likelihood for the model.</span></span>
<span>  evaluateLogLikelihood <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span>, <span class="va">discrete</span>, <span class="va">covariance</span>, <span class="va">datalist</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">w_r</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">w_c</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="va">w_s</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">datalist</span><span class="op">$</span><span class="va">N</span></span>
<span>    <span class="va">ll</span> <span class="op">&lt;-</span> <span class="fl">0</span>;</span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">discrete</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>         <span class="va">ll</span> <span class="op">&lt;-</span> <span class="va">ll</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">datalist</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">w_r</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">discrete</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>         <span class="va">ll</span> <span class="op">&lt;-</span> <span class="va">ll</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">datalist</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">w_c</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>         <span class="va">ll</span> <span class="op">&lt;-</span> <span class="va">ll</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">datalist</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">w_s</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">ll</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="settings-and-run-model">3.3. Settings and run model<a class="anchor" aria-label="anchor" href="#settings-and-run-model"></a>
</h3>
<p>Select the run time, chains, number of cores, burnin and thinning for
the model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Settings used for the ptmc model </span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  numberChainRuns <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  numberCores <span class="op">=</span> <span class="va">mc.cores</span>,</span>
<span>  numberTempChains <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">100000</span>,</span>
<span>  burninPosterior <span class="op">=</span> <span class="fl">50000</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">post</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ptmc_discrete_func.html">ptmc_discrete_func</a></span><span class="op">(</span>model<span class="op">=</span><span class="va">model</span>, data<span class="op">=</span><span class="va">data_t</span>, settings<span class="op">=</span><span class="va">settings</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="analyse-the-posterior-distributions">4. Analyse the posterior distributions<a class="anchor" aria-label="anchor" href="#analyse-the-posterior-distributions"></a>
</h2>
<p><code>ptmc_discrete_func</code> returns a list of with entries:</p>
<ul>
<li>: An MCMC object with posterior samples of the model
parameters.</li>
<li>: A list of discrete states generated during the simulation for each
chain.</li>
<li>: A data frame of log-posterior values, with columns representing
different chains and rows representing samples.</li>
<li>: A data frame of temperatures for each chain at each sample.</li>
<li>: A data frame of acceptance rates for each chain at each
sample.</li>
<li>: A list containing the parameter values for each chain.</li>
</ul>
<p>. The first entry is <code>post$mcmc</code> a mcmc or mcmc.list
object (from the <code>coda</code> package). You can plot these and
calculate convergence diagnostics using coda functions:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">mcmc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">post</span><span class="op">$</span><span class="va">mcmc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">mcmc_trace</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/plot%20outcomes%20mcmc-1.png" width="672"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the Gelman-Rubin diagnostic for the parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.plot.html" class="external-link">gelman.plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">mcmc</span><span class="op">)</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/plot%20outcomes%20mcmc-2.png" width="672"></p>
<p>The next entry is <code>post$lpost</code> and is long table dataframe
of the log-posterior values. These values can be easily plotted using
ggplot2:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Plot of the logposterior for the three chains</span></span>
<span><span class="va">lpost_conv</span> <span class="op">&lt;-</span> <span class="va">post</span><span class="op">$</span><span class="va">lpost</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_no</span><span class="op">&gt;</span><span class="fl">250</span><span class="op">)</span></span>
<span><span class="va">logpostplot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">lpost_conv</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sample_no</span>, y <span class="op">=</span> <span class="va">lpost</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">chain_no</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span>, alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">logpostplot</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/plot%20outcomes%20lpost-1.png" width="672"></p>
<p>The next entry is <code>post$discrete</code> and is a list of
matrices describing the discrete states for each chain. These can be
easily plotted using ggplot2 also:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="va">df_discrete</span> <span class="op">&lt;-</span> <span class="fu">make_long_discrete</span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">discrete</span><span class="op">)</span></span>
<span></span>
<span><span class="va">weather_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span> <span class="op">=</span> <span class="st">"rainy"</span>, <span class="st">"2"</span> <span class="op">=</span> <span class="st">"cloudy"</span>, <span class="st">"3"</span> <span class="op">=</span> <span class="st">"sunny"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">df_discrete_plt</span> <span class="op">&lt;-</span> <span class="va">df_discrete</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">weather_key</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">idx</span>, levels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span> </span>
<span>    </span>
<span> <span class="va">df_discrete_plt</span>   <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">idx</span>, y <span class="op">=</span> <span class="va">sample_no</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"#f6cb2e"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"gray30"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"#1eaefe"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Sample number"</span>, y <span class="op">=</span> <span class="st">"Weather state"</span>, fill <span class="op">=</span> <span class="st">"Weather"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/plot%20outcomes%20discrete-1.png" width="672"></p>
<p>Let‚Äôs find the most probable weather state for each day based on the
posterior samples and compare it to the true weather state (box color
below 0.0)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recode_emoji</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"\U1F602"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"‚òÅÔ∏è"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"üåßÔ∏è"</span><span class="op">)</span></span>
<span><span class="va">recode_emoji_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"#f6cb2e"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"gray30"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"#1eaefe"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">true_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>,</span>
<span>    true <span class="op">=</span> <span class="va">latent_weather</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">true</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">recode_emoji_color</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>true_emoji <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">true</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">recode_emoji</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="va">df_discrete_plt</span><span class="op">$</span><span class="va">sample_no</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unique</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">length</span></span>
<span></span>
<span><span class="va">df_discrete_plt_mode</span> <span class="op">&lt;-</span> <span class="va">df_discrete_plt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">idx</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">S</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">df_discrete_plt_mode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">idx</span>, y <span class="op">=</span> <span class="va">n</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">true_sim</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">idx</span> <span class="op">-</span> <span class="fl">0.3</span>, xmax <span class="op">=</span> <span class="va">idx</span> <span class="op">+</span> <span class="fl">0.3</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="fl">0.3</span>, ymax <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, fill <span class="op">=</span> <span class="va">true</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"#f6cb2e"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"gray30"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"#1eaefe"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Sample number"</span>, y <span class="op">=</span> <span class="st">"Weather state"</span>, fill <span class="op">=</span> <span class="st">"Weather"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Example3_files/figure-html/plot%20outcomes%20compare-1.png" width="672"></p>
<p>##¬†5. simulation recovery metrics</p>
<p>Here are a few easy distance metrics to compare the true and
recovered weather states.</p>
<div class="section level3">
<h3 id="simple-matching-coefficient-smc">5.1. Simple Matching Coefficient (SMC)<a class="anchor" aria-label="anchor" href="#simple-matching-coefficient-smc"></a>
</h3>
<p>The SMC calculates the proportion otrue_sim f elements in the vectors
that match exactly.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recode_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sunny"</span> <span class="op">=</span> <span class="st">"3"</span>, <span class="st">"cloudy"</span> <span class="op">=</span> <span class="st">"2"</span>, <span class="st">"rainy"</span> <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">true_vec</span> <span class="op">&lt;-</span> <span class="va">true_sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>true_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">true</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">recode_number</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">true_num</span><span class="op">)</span></span>
<span><span class="va">model_est_vec</span> <span class="op">&lt;-</span> <span class="va">df_discrete_plt_mode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value_num <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">recode_number</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value_num</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># SMC calculation</span></span>
<span><span class="va">smc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">true_vec</span> <span class="op">==</span> <span class="va">model_est_vec</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true_vec</span><span class="op">)</span></span>
<span><span class="va">smc</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="distance-metrics">5.2. Distance Metrics<a class="anchor" aria-label="anchor" href="#distance-metrics"></a>
</h3>
<p>Use Hamming, Euclidean, and Manhattan distances.</p>
<ol style="list-style-type: lower-alpha">
<li>Hamming Distance Hamming distance is the proportion of mismatched
elements.</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Hamming distance</span></span>
<span><span class="va">hamming_distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">true_vec</span> <span class="op">!=</span> <span class="va">model_est_vec</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">true_vec</span><span class="op">)</span></span>
<span><span class="va">hamming_distance</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.2</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">6. Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this vignette, we have shown how to recover a discrete latent
variable model using simulated data on daily weather conditions and
associated Negroni sales. A silly example, but an easy one to
understand. More complex examples to come!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Hodgson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
